#!/bin/bash

turi="https://api.opensea.io/api/v1/collection"

tlp=${HOME}/Downloads/nftmaven/top100
ds=`date "+%Y-%m-%d"`
dpath=${tlp}/${ds}

for chain in ethereum solana matic klaytn; do
   echo "** chain => ${chain} **"
   dlfn="${dpath}/${chain}.json"
   head -n 1 ${dlfn} | perl -p -e 's,^.+__wired__=({.+})</script><script>window.__sidecar_config__=.+$,$1,' | jq > /tmp/${chain}.json

   cdpath=${tlp}/${ds}/${chain}
   rm -rf ${cdpath}
   mkdir -p ${cdpath}

   IFS=$'\n'
   cidx=1
   for slug in `jq --raw-output '.records | to_entries | .[] | select(.value.__typename == "CollectionType") | .value.slug' /tmp/${chain}.json`; do
      fn=$(printf "%03d_%s_%s" ${cidx} ${ds} "${slug}")
      ((cidx++))
      dlfn="${cdpath}/${fn}.json"

      echo ${fn}
      response=$(curl -L -s -o ${dlfn} -w "%{http_code}"  --header 'Accept: application/json' --request GET --url "${turi}/${slug}")
      if ((response != 200)); then
         echo "response: $response"
         echo 'response != 200 => aborting'
         break
      fi
   done
done
